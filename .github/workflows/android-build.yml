name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [created]

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      # 如果你的 package.json 里本来就有 @capacitor/cli/@capacitor/android，可删除这步
      - name: Ensure Capacitor packages
        run: npm install --no-save @capacitor/cli @capacitor/android

      # 关键：CI 强制写入正确配置，确保 webDir=www，且不含 bundledWebRuntime
      - name: Force Capacitor config for CI
        shell: bash
        run: |
          echo "PWD=$(pwd)"
          echo "SHA=$(git rev-parse HEAD)"

          test -d www && ls -la www | head || (echo "www missing" && exit 1)

          cat > capacitor.config.json <<'JSON'
          {
            "appId": "com.audiovisual.player",
            "appName": "AudioVisual",
            "webDir": "www",
            "server": { "androidScheme": "https" },
            "plugins": { "Browser": { "prefersDeepLink": false } }
          }
          JSON

          echo "=== capacitor.config.json (CI) ==="
          cat capacitor.config.json

      - name: Clean Android folder if exists
        shell: bash
        run: |
          if [ -d android ]; then
            rm -rf android
          fi

      - name: Add Android platform
        run: npx cap add android

      - name: Sync Android
        run: npx cap sync android

      - name: Build Android APK
        shell: bash
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug
          ./gradlew assembleRelease

      # PR 事件通常拿不到 secrets，所以不在 PR 上签名
      - name: Check signing secrets present
        if: github.event_name != 'pull_request'
        shell: bash
        run: |
          if [ -z "${{ secrets.ANDROID_SIGNING_KEY }}" ]; then
            echo "ANDROID_SIGNING_KEY is EMPTY"
            exit 1
          fi
          if [ -z "${{ secrets.ANDROID_KEY_ALIAS }}" ]; then
            echo "ANDROID_KEY_ALIAS is EMPTY"
            exit 1
          fi
          if [ -z "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" ]; then
            echo "ANDROID_KEYSTORE_PASSWORD is EMPTY"
            exit 1
          fi
          if [ -z "${{ secrets.ANDROID_KEY_PASSWORD }}" ]; then
            echo "ANDROID_KEY_PASSWORD is EMPTY"
            exit 1
          fi
          echo "All signing secrets are present."

      - name: Sign APK
        if: github.event_name != 'pull_request'
        uses: ilharp/sign-android-release@v2
        id: sign_app
        continue-on-error: true
        with:
          releaseDir: android/app/build/outputs/apk/release
          signingKey: ${{ secrets.ANDROID_SIGNING_KEY }}
          keyAlias: ${{ secrets.ANDROID_KEY_ALIAS }}
          keyStorePassword: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Upload Debug APK
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audiovisual-debug-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk

      - name: Upload Release APK (unsigned)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audiovisual-release-unsigned-apk
          path: android/app/build/outputs/apk/release/app-release-unsigned.apk

      - name: Upload Signed APK
        if: steps.sign_app.outputs.signedFile != null
        uses: actions/upload-artifact@v4
        with:
          name: audiovisual-signed-apk
          path: ${{ steps.sign_app.outputs.signedFile }}
