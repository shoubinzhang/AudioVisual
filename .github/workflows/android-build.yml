name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [created]

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # 你的项目依赖里如果本来就有 @capacitor/cli/@capacitor/android，
      # 也可以删掉这一步；保留它是为了保证 CI 一定有 cap 命令可用
      - name: Install Capacitor CLI
        run: npm install @capacitor/cli @capacitor/android

      # 关键：在 CI 强制写入一个正确的 capacitor.config.json，避免任何来源的 webDir="."
      - name: Force Capacitor config for CI
        shell: bash
        run: |
          echo "PWD=$(pwd)"
          echo "SHA=$(git rev-parse HEAD)"

          # 确保 www 存在
          test -d www && ls -la www | head || (echo "www missing" && exit 1)

          # 生成（或覆盖）root capacitor.config.json，确保 webDir=www 且没有 bundledWebRuntime
          cat > capacitor.config.json <<'JSON'
          {
            "appId": "com.audiovisual.player",
            "appName": "AudioVisual",
            "webDir": "www",
            "server": { "androidScheme": "https" },
            "plugins": { "Browser": { "prefersDeepLink": false } }
          }
          JSON

          echo "=== capacitor.config.json (CI) ==="
          cat capacitor.config.json

          echo "=== capacitor.config.ts (repo) ==="
          test -f capacitor.config.ts && sed -n '1,200p' capacitor.config.ts || true

          echo "=== any capacitor.config.* (maxdepth 5) ==="
          find . -maxdepth 5 -name "capacitor.config.*" -print

          echo "=== grep bundledWebRuntime/webDir ==="
          grep -RIn "bundledWebRuntime" . || true
          grep -RIn "webDir" . || true

      - name: Clean Android folder if exists
        shell: bash
        run: |
          if [ -d android ]; then
            echo "android/ exists, removing for clean add..."
            rm -rf android
          fi

      - name: Add Android platform
        run: npx cap add android

      - name: Sync Android
        run: npx cap sync android

      - name: Build Android APK
        shell: bash
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug
          ./gradlew assembleRelease

      - name: Sign APK
        uses: ilharp/sign-android-release@v1
        id: sign_app
        with:
          releaseDir: android/app/build/outputs/apk/release
          signingKey: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: audiovisual-debug-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: audiovisual-release-apk
          path: android/app/build/outputs/apk/release/app-release-unsigned.apk

      - name: Upload Signed APK
        if: steps.sign_app.outputs.signedFile != null
        uses: actions/upload-artifact@v4
        with:
          name: audiovisual-signed-apk
          path: ${{ steps.sign_app.outputs.signedFile }}
